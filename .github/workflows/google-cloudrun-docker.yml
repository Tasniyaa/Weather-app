name: Build and Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: stone-fortress-414817
  RUN_SA_KEY: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic3RvbmUtZm9ydHJlc3MtNDE0ODE3IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiYjljZmU4NTcwNzM2NGMxMzZlMDA0MWViYWE3YTc0MGRiNjg3NTFiMCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDYkpTczBUa004Q0Nxdlxub0hsaURkL25rVk1qTmxkSmg5THIzd1B3Rld5T2pnRGgxalhpY3gzSjhLNUlMOW5GUXhlak9xcDJjSC9VaUo3MVxudy81Q2lNL1l6L3NFQUV5SktpTFEyNHRhaTc4bmFMMFlBQU01eVVjTUtwd3FPSkI4dHptNUxjMmJVSG5IRC9zQ1xuWmxVakZ2T2xPZVNidml4Z2Y0dlNJMDdYSEZkSGVMTkNoeVN5MCtQdGVzNFpvandoNDdaTGNrc0lGTWNLblBBa1xuUmo4VzlRVldTSU5GWktLUVc3NEMzR0tjK0VFQkNQbTQ1dGNxSlozSVViQXE2NkFZeGhmeUFxeTk0SlE5MkZqUlxudU9iekdFeVdoQ3ljTzgvWUplVnJ2cm9ybnhjazcvcWkzeHdkaW9RTnpIZDJka1FpQWxYUC92NUxRQml1eVFzWlxuRnVBTG1rQ3hBZ01CQUFFQ2dnRUFBMC9VejBZSWEyU2xQS0NKVnMyREJSZDJGZDlZRjZxOWx1bG8xUnd2K0E4UlxuOThBeDRFYWkwU2ZCSUt0YzA3Z3Q3ZjhYbW5XbVZPd2hzSTloZ3h3V2k4Tk0wWFlNTERWcER0cFE3RHJsZHJybVxucG5lQm1oOHcxQktveU1IeVc2Y3hwVUZVRFVlM2djZFdqV09QMTdMcXVwRTB6eHBOS2pZdXp1cVFDVW1DbDNUMFxubys0NExpcnB4NXZSMHRsYlVIbkVTdTRlVWdseWk1S3ZDMXowankwK3Q1eGJnVW11TjVNK3VwSG51VmZmOThxTlxuY3BFbkQxb0hVdDdzRE5veFVuaWtoM1gvMFBLNFJUcXN0b0xocWxQb3p6bitWNW0xMDFNVE1aMUs5b0FCcTJSS1xua0RlU1l4anUxUjl2NnpvaDJEbjM1Z21vOEtmc2c1UTJLQ3h6Y3RHK2JRS0JnUURMelRPWjN6eTVKa1ZSZ1BWZ1xubnpYL1BpWnV3Uk1KaE1xZTE1Znk2NHVZQU43R2xOYWlYRUh5MXpWSlJmVzNpTEdySmxYcGZiTlA1YnZUaTh1QVxuWVY3cmpUaGFNME05U2pxbHI4SnppRlZTa0Q3SzFXVEVRaVp0U1BOQUxRK3Zmc0YxUjEyQkVob29od2NJbllXY1xub0ZqWjFzeVFhNWc3emdHcFJUR2ZEM3NoS3dLQmdRREM0YTVJc25QY0xrM3RqMzRxYUszd3Y2SmVLNW5oTTU0OFxuYmlydExMcUNsaTFVYzVYMXVmYWF0bXlzRFBrbHpZU2s2OEVmV3FKOVRCL1pYbnlBTm1jc1grK1o2cFhNRXJ2blxuUUF3QzExbnFvTzZLcUVWOThtek5HVitYVDNKSFh0TGFLN2pCNWcwQ0NRSmNQbjB0QmFGbzhRc1hRem5iSTU2ZlxueWtUWHQ2WWZrd0tCZ0hDOGtZZlR5b1p0R2psTXllL3FBbmV3VEpoRnE1OC9Xc3BsWG9PZE1yb2grUm9HcVhoa1xuNm9KSDlBMFZheWhjc0ZPSndFcUtJMC9XT0lGOE9sVkpCN1hyaDdtMTA4TXF0YWlEd21BZ2tYbzdtdENmSEwvSVxuQy9PMlFBRkhLLzhiY2k3TERIbGlweCsyR2ZqMUVqMGpJaU5XeEJBN3hKbUlpcmkxTXc3WEJIakRBb0dBTHF1N1xuZ0Y5MFRjT3RGL3BvWGFHcUhtRFdjclVBYWlWaGZObHBZRmw0NVRNdjhleW9laXVwK2swNzQweE1FcGlRYnFxalxuR200clFkU01RQk5YdjZESHZxSFBFTTVVUjRZcEIrMlhzc3ArRnltcFZ2MkxmdWtpMDArRFRBcFR0UEhwanlRdlxuWUFoSER6aTNIdjQ4SGg4ZUU3SytWRGplVHpQTmxqanJtYm02aUE4Q2dZRUFyd1FYcHVZRkYzdGRvMlhmSm40OVxuWk1rb0FwcEdXTFdPOG4yWEdwMm5uckg4cWRIMnFFYm5xQzgxRmsrSk5peUlKTWxDMTJVL216NUl5ZjUwZjJZUlxuTHBEdE5FdHM5M1NzczdKYTc0aitMclUxTnhkZ1d1WHNRTm5lcEFmN2dBZFJJY29iRGRPaDFwYU9jWnFhY3pVS1xuR0U2UDVyV0E0NENvcXZJNm43K0tNUmc9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiY2xvdWQtcnVuQHN0b25lLWZvcnRyZXNzLTQxNDgxNy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDg0ODYyOTkwNDcxMjYwNDAwNDEiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2Nsb3VkLXJ1biU0MHN0b25lLWZvcnRyZXNzLTQxNDgxNy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQ==
  SERVICE: weather-app 
  REGION: us-central1 

jobs:
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
        # Debugging output: Print the value of PROJECT_ID variable
    - name: Debug
      run: |
        echo "Project ID: $PROJECT_ID"
        echo "key: $RUN_SA_KEY"
    # Setup gcloud CLI
    - uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: '>= 416.0.0'
        service_account_key: $RUN_SA_KEY
        project_id: ${{ env.RUN_PROJECT }}

    # Build and push image to Google Container Registry
    - name: Build
      run: |-
        gcloud builds submit \
          --quiet \
          --project "${{ env.PROJECT_ID }}" \
          --tag "gcr.io/$PROJECT_ID/$SERVICE:$GITHUB_SHA"
          
    # Deploy image to Cloud Run
    - name: Deploy
      run: |-
        gcloud run deploy "$SERVICE" \
          --quiet \
          --region "$REGION" \
          --image "gcr.io/$PROJECT_ID/$SERVICE:$GITHUB_SHA" \
          --platform "managed" \
          --allow-unauthenticated
